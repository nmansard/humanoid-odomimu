% !TEX root = main.tex


% More macros
\newcommand{\bw}{{\bfomega}}
\newcommand{\bth}{{\bftheta}}
\newcommand{\bphi}{{\bfphi}}
\newcommand{\nth}{\norm{\bth}}
\newcommand{\ab}{{\bfa_b}}
\newcommand{\wb}{{\bw_b}}
\newcommand{\D}{\Delta}
\newcommand{\Dzero}{{\D^0}}
\newcommand{\Dp}{{\D\bfp}}
\newcommand{\Dv}{{\D\bfv}}
\newcommand{\Dth}{{\D\bth}}
\newcommand{\Dq}{{\D\bfq}}
\newcommand{\DR}{{\D\bfR}}
\newcommand{\DP}{{\D\bfP}}
\newcommand{\DV}{{\D\bfV}}
\newcommand{\DTH}{{\D\bfTheta}}
\newcommand{\Dw}{{\D\bw}}
\newcommand{\DW}{{\D\bfOmega}}
\newcommand{\dpp}{{\delta\bfp}}
\newcommand{\dv}{{\delta\bfv}}
\newcommand{\dth}{{\delta\bth}}
\newcommand{\dq}{{\delta\bfq}}
\newcommand{\dR}{{\delta\bfR}}
\newcommand{\dP}{{\delta\bfP}}
\newcommand{\dV}{{\delta\bfV}}
\newcommand{\dTH}{{\delta\bfTheta}}
\newcommand{\dw}{{\delta\bw}}

\newcommand{\te}{\triangleq}
\newcommand{\od}{\odot}

% Helper /keys/ 
\newcommand{\tcom}[1]{{\footnotesize/\texttt{#1}/} }
\newcommand{\com}[1]{{\footnotesize/\texttt{#1}/~} }
\newcommand{\cdef}{\com{def}}
\newcommand{\cchain}{\com{chain}}
\newcommand{\ccross}{\com{cross}}
\newcommand{\cJr}{\com{Jr}}
\newcommand{\csmall}{\com{small}}
\newcommand{\cswap}{\com{swap}}
\newcommand{\ctrans}{\com{trans}}
\newcommand{\clog}{\com{Log}}
\newcommand{\clim}{\com{lim}}
\newcommand{\ccancel}{\com{cancel}}
\newcommand{\cexpand}{\com{expand}}
\newcommand{\csubst}{\com{subst}}

\section{IMU pre-integration in S3 and SO(3)}
\subsection{Quaternion rotations}

We define the quaternion-by-vector product $\od$ so that
%
\begin{align}
\bfq\od\bfv \te \bfq\ot\bfv\ot\bfq^*
~,
\end{align}
%
where the symbol $\ot$ indicates the quaternion product.
That is, quaternion-by-vector products using the symbol $\od$ perform 3D rotations. 
%This product satisfies,
%%
%\begin{align*}
%\bfq_2\od(\bfq_1\od\bfv) &= (\bfq_2\ot\bfq_1)\od\bfv
%\end{align*}
%%
%that is, the group of quaternions $(\bfq\in\bbH,\ot)$ is a transformation group acting on 3D vectors through the rotation action $\od$.
Notice that if $\bfR$ is the rotation matrix equivalent to the quaternion $\bfq$, then $\bfq\od\bfv = \bfR\,\bfv$ and $\bfq^*\od\bfv = \bfR\tr\,\bfv$. 
In practice, the operator $\od$ may be implemented as ~$\bfq\od\bfv = \bfq\ot\bfv\ot\bfq^*$ ~or~ $\bfq\od\bfv = \bfR\,\bfv$, whichever is faster.

\subsection{Exp and Log maps}

We use vectorized versions of the exponential and logarithmic maps in $S3$ (the group of unit quaternions) and $SO(3)$ (the group of rotation 3-matrices), and mark them with capitalized names $\Exp()$ and $\Log()$. They operate directly on the vector space $\bbR^3$, and use either quaternions as the representation of $S3$,
%
\begin{subequations}
\begin{align}
\bfq
%\{\bth\} 
&= \Exp(\bth) \te \begin{bmatrix}
\cos(\theta/2) \\ \bfu\sin(\theta/2)
\end{bmatrix}\\ 
\theta\bfu &= \Log(\bfq) \te 2\,\qv\frac{\arctan({\norm{\qv},q_w})}{\norm{\qv}}
~,
\end{align}
\end{subequations}
%
or rotation matrices as the representation of $SO(3)$, 
%
\begin{subequations}
\begin{align}
\bfR
%\{\bth\} 
&= \Exp(\bth) \te \bfI + \sin\theta\hatx{\bfu} + (1-\cos\theta)\hatx{\bfu}^2~ \label{equ:rodrigues} \\ 
\theta\bfu &= \Log(\bfR) \te \frac{\theta(\bfR-\bfR\tr)^\vee}{2\sin\theta} 
~,
\end{align}
\end{subequations}
%
with $\theta=\cos\inv\left(\frac{\trace(\bfR)-1}{2}\right)$,
and where $\bullet^\vee$, known as the \emph{vee} operator, is the inverse of the \emph{skew} operator $\hatx{\bullet}$. 
Their exact form ($\bfq$ or $\bfR$) is always clear by the context.




%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Delta definitions}

Consider a non-rotating reference frame that is free-falling at the acceleration of gravity. An IMU glued to this frame would measure null accelerations and rotations. Any non-null measurements would imply motion of the IMU \wrt this frame.

The deltas $\D\!=\!(\Dp,\Dv,\Dq)$ are defined as the motion (position, velocity, orientation) of a body \wrt a non-rotating frame that is free-falling at the acceleration of gravity $\bfg$. At $t=t_i$, this frame was at position $\bfp_i$ and orientation $\bfq_i$, and moving at velocity $\bfv_i$. Then, the deltas $\D_{ij}$ at time $t=t_j$ \wrt time $t=t_j$ respond to the expression,
%
\begin{align}
\begin{split}
\Dp_{ij} &= \bfq_i^*\od\Big(\bfp_j - \bfp_i - \bfv_i\Dt_{ij} - \frac12\bfg\Dt_{ij}^2\Big) \\
\Dv_{ij} &= \bfq_i^*\od(\bfv_j - \bfv_i - \bfg\Dt_{ij}) \\
\Dq_{ij} &= \bfq_i^*\ot\bfq_j 
\end{split}
\end{align}
%
where $\Dt_{ij} \te t_j - t_i$. Interestingly, the deltas form a group under the composition operator $\D_{ik}\te\D_{ij}\oplus\D_{jk}$, defined by,
%
\begin{align} \label{equ:g_composition}
\begin{split}
\Dp_{ik} 
&= \Dp_{ij} + \Dv_{ij}\Dt_{jk} + \Dq_{ij}\od\Dp_{jk} \\
\Dv_{ik} 
&= \Dv_{ij} + \Dq_{ij}\od\Dv_{jk} \\
\Dq_{ik} 
&= \Dq_{ij}\ot\Dq_{jk} 
\end{split}
\end{align}
%
with identity $\D_0=[(0,0,0),(0,0,0),(1,0,0,0)]$, and inverse $\D_{ji}\te\D_{ij}\inv$ shuch that $\D\inv\op\D=\D\oplus\D\inv=\D_0$, given by,
%
\begin{align}
\begin{split}
\Dp_{ji} 
&= -\Dq_{ij}^*\od(\Dp_{ij} - \Dv_{ij}\Dt_{ij}) \\
\Dv_{ji} 
&= -\Dq_{ij}^*\od\Dv_{ij} \\
\Dq_{ji} 
&= \Dq_{ij}^*
~.
\end{split}
\end{align}


\subsection{State integration}

We define the world-referenced states of position, velocity, and orientation quaternion, $\bfx\!=\!(\bfp,\bfv,\bfq)$. 
Their time evolution is governed by the kinematic equation,
%
\begin{align}\label{equ:cont_basic}
\dot\bfp &= \bfv \\
\dot\bfv &= \bfq\od\bfa + \bfg \\
\dot\bfq &= \frac12\bfq\ot\bw 
\end{align}
%
where we identify $\bfb=(\bfa,\bw)$ as the \emph{body magnitudes}, that is, the magnitudes of acceleration and angular rate in the IMU reference frame.
Assuming constant body magnitudes within the interval $\dt\te t_k-t_j$, we have the discrete-time relation
%
\begin{align}\label{equ:g_second_order_integration}
\begin{split}
\bfp_{k} &= \bfp_j + \bfv_j\dt  + \frac12\bfg\dt^2 + \frac12\bfq_j\od\bfa_j\dt^2 \\
\bfv_{k} &= \bfv_j + \bfg\dt + \bfq_j\odot\bfa_j\dt \\
\bfq_{k} &= \bfq_j\ot\Exp(\bw_j\dt/2) 
\end{split}
\end{align}


\subsection{Incremental delta pre-integration}
%
Substituting the delta definitions in the integration equation, we obtain the incremental delta pre-integration,
%
\begin{align}\label{equ:g_second_order_pre-integration}
\begin{split}
\Dp_{ik} 
&= \Dp_{ij} + \Dv_{ij}\dt + \frac12\Dq_{ij}\od\bfa_j\dt^2 \\
\Dv_{ik} 
&= \Dv_{ij} + \Dq_{ij}\od\bfa_j\dt \\
\Dq_{ik} 
&= \Dq_{ij}\ot\Exp(\bw_j\dt) 
\end{split}
\end{align}
%
Noticing that we can define a proper delta $\delta_{jk}$ from the body magnitudes $\bfb_j=(\bfa_j,\bw_j)$ at time $t_j$,
%
\begin{align}\label{equ:delta_creation}
\begin{split}
\dpp_{jk} &= \frac12\bfa_j\dt^2 \\
\dv_{jk} &= \bfa_j\dt \\
\dq_{jk} &= \Exp(\bw_j\dt)
\end{split}
\end{align}
%
the integration \eqRef{equ:g_second_order_pre-integration} can be expressed as the composition \eqRef{equ:g_composition}, 
%
\begin{align}\label{equ:composition_compact}
\D_{ik}=\D_{ij}\oplus\delta_{jk}
~.
\end{align}
%


%\subsection{State reconstruction}
%
%It follows from the Delta definitions
%%
%\begin{align}
%\begin{split}
%\bfp_j &= \bfp_i + \bfv_i\Dt_{ij} + \frac12\bfg\Dt_{ij}^2 + \bfq_i\od\Dp_{ij} \\
%\bfv_j &= \bfv_i + \bfg\Dt_{ij} + \bfq_i\od\Dv_{ij} \\
%\bfq_j &= \bfq_i\ot\Dq_{ij}   
%\end{split}
%\end{align}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Jacobians}

\newcommand{\jac}[2]{{\bfJ^{#1}_{#2}}}

Notation: %Uncertainties and perturbed magnitudes are respectively marked by the prefix $\partial$ and the tilde\, $\widetilde\cdot$\,, and are represented as follows,
%%
%\begin{align*}
%\widetilde\Dp &= \Dp + \partial\Dp & \partial\Dp &= \widetilde\Dp-\Dp \\
%\widetilde\Dv &= \Dv + \partial\Dv & \partial\Dv &= \widetilde\Dv-\Dv \\
%\widetilde\Dq &= \Dq \ot \Exp( \partial\Dth ) & \partial\Dth &= \Log(\Dq^*\ot\widetilde\Dq) 
%\end{align*}
%
We %also 
note the Jacobians $\jac{y}{x}\te\dpar{y}{x}$. 



\subsubsection{Jacobians of the body magnitudes}

We consider biased and noisy measurements of the body magnitudes, so that,
%
\begin{align}
\begin{split}
\bfa &= \bfa_m - \ab + \bfa_n \\
\bw &= \bw_m - \wb + \bw_n 
~,
\end{split}
\end{align}
%
with $\bullet_m$ the measurements, $\bullet_b$ the biases, and $\bullet_n$ the noises.
We have immediately
%
\begin{align}
\jac{\bfb}{\bfb_m}&=\bfI_6 & \jac{\bfb}{\bfb_b}&=-\bfI_6 & \jac{\bfb}{\bfb_n}&=\bfI_6
~.
\end{align}

\subsubsection{Jacobians of the current delta}
\label{sec:jac_data}

The involved operations are the delta creation \eqRef{equ:delta_creation} whose Jacobians are mostly obtained by simple inspection,
%
\begin{align}
\jac{\delta}{\bfb} =
\begin{bmatrix}
\frac12\bfI\dt^2 	& \bf0 \\
\bfI\dt 			& \bf0 \\
\bf0 				& \bfJ_r(\bw\dt)\dt% ~~,\textrm{ (see below)} 
\end{bmatrix}
\end{align}
%
%\begin{align*}
%\jac{\dpp}{\bfa} &= \frac12\bfI\dt^2 	& \jac{\dpp}{\bw} &= \bf0 \\
%\jac{\dv}{\bfa} &= \bfI\dt 			& \jac{\dv}{\bw} &= \bf0 \\
%\jac{\dth}{\bfa} &= \bf0 				& \jac{\dth}{\bw} &= \bfJ_r(\bw\dt)\dt ~~,\textrm{ (see below)} 
%\end{align*}
%
We develop $\bfJ^\dth_\bw$ as follows,
%
\begin{align*}
\widetilde\dq \te \dq\ot\Exp(\partial\dth) 
&= \Exp((\bw+\partial\bw)\dt) \\
\cJr &= \Exp(\bw\dt)\ot\Exp(\bfJ_r(\bw\dt)\partial\bw\dt) \\
%\csubst 
&= \dq \ot \Exp(\bfJ_r(\bw\dt)\partial\bw\dt)
~,
\end{align*}
%
which leads to 
$\partial\dth = \bfJ_r(\bw\dt)\partial\bw\dt$ 
and thus the result above.



\subsubsection{Jacobians of $\D^+=\D\op\delta$ \wrt $\D$}
\label{sec:jac_first_delta}

The involved operations are the delta composition \eqRef{equ:composition_compact} detailed in \eqRef{equ:g_composition}.
%, that we note here $\D^+=\D\op\delta$.
Again by simple inspection we can obtain a number of Jacobians,
%
\begin{align}
\jac{\D^+}{\D} = \begin{bmatrix}
\bfI  & \bfI\dt & - \DR_{ij}  \hatx{\dpp_{jk}}  \\
\bf0  & \bfI    & - \DR_{ij}  \hatx{\dv_{jk}} \\
\bf0  & \bf0    &   \dR_{jk}\tr 
\end{bmatrix}
\end{align}
%
%\begin{align*}
%\jac{\Dp^+}{\Dp}   &= \bfI  & \jac{\Dp^+}{\Dv} &= \bfI\dt & \jac{\Dp^+}{\Dth}  &= - \DR_{ij}  \hatx{\dpp_{jk}}  \\
%\jac{\Dv^+}{\Dp}   &= \bf0  & \jac{\Dv^+}{\Dv} &= \bfI & \jac{\Dv^+}{\Dth}  &= - \DR_{ij}  \hatx{\dv_{jk}} \\
%\jac{\Dth^+}{\Dp}  &= \bf0  & \jac{\Dth^+}{\Dv} &= \bf0 & \jac{\Dth^+}{\Dth} &= \dR_{jk}\tr 
%~.
%\end{align*}
%
%We develop $\DP_\Dth$ as follows
%%
%\begin{align*}
%\widetilde\Dp_{ik} \te \Dp_{ik}+\partial\Dp_{ik} 
%&= \Dp_{ij} + \Dv_{ij}\dt + \widetilde\DR_{ij}\dpp_{jk} \\
%&= \Dp_{ij} + \Dv_{ij}\dt + \DR_{ij}\Exp(\partial\Dth_{ij})\dpp_{jk} \\
%\csmall
%&= \Dp_{ij} + \Dv_{ij}\dt + \DR_{ij}(\bfI+\hatx{\partial\Dth_{ij}})\dpp_{jk} \\
%&= \underbrace{\Dp_{ij} + \Dv_{ij}\dt + \DR_{ij}\dpp_{jk}} + \DR_{ij}\hatx{\partial\Dth_{ij}}\dpp_{jk} \\
%\com{subst, cross}
%&= ~~~~~~~~~~~~~~~\Dp_{ik} ~~~~~~~~~~~~~  - \DR_{ij}\hatx{\dpp_{jk}}\partial\Dth_{ij} 
%\end{align*}
%%
%therefore,
%%
%\begin{align}
%\DP^+_\Dth \te \dpar{\Dp_{ik}}{\Dth_{ij}} = - \DR_{ij}\hatx{\dpp_{jk}}
%\end{align}
%%
%Similarly for the velocity,
%%
%\begin{align}
%\DV^+_\Dth \te \dpar{\Dv_{ik}}{\Dth_{ij}} = - \DR_{ij}\hatx{\dv_{jk}}
%\end{align}
%%
%Finally for the orientation,
%%
%\begin{align*}
%\widetilde\DR_{ik} \te \DR_{ik}\Exp(\partial\Dth_{ik}) 
%&= \widetilde\DR_{ij}\dR_{jk} \\
%&= \DR_{ij}\Exp(\partial\Dth_{ij})\dR_{jk}  \\
%\cswap
%&= \DR_{ij}\dR_{jk}\Exp(\dR_{jk}\tr\partial\Dth_{ij})  \\
%&= \DR_{ik}\Exp(\dR_{jk}\tr\partial\Dth_{ij})  
%\end{align*}
%%
%which leads to
%%
%\begin{align*}
%\Dth_{ik} &= \dR_{jk}\tr\partial\Dth_{ij}
%\end{align*}
%%
%therefore,
%%
%\begin{align}
%\DTH^+_\Dth \te \dpar{\Dth_{ik}}{\Dth_{ij}} = \dR_{jk}\tr
%\end{align}




\subsubsection{Jacobians of $\D^+=\D\op\delta$ \wrt $\delta$}
\label{sec:jac_second_delta}

By simple inspection of \eqRef{equ:g_composition} we obtain,
% we can obtain a number of Jacobians,
%
\begin{align}
\jac{\D^+}{\delta} = \begin{bmatrix}
\DR_{ij} & \bf0     & \bf0 \\
\bf0     & \DR_{ij} & \bf0 \\
\bf0     & \bf0     & \bfI  
\end{bmatrix}
\end{align}
%
%\begin{align*}
%\jac{\Dp^+}{\dpp} &= \DR_{ij} & \jac{\Dp^+}{\dv} &= \bf0     & \jac{\Dp^+}{\dth} &= \bf0 \\
%\jac{\Dv^+}{\dpp} &= \bf0     & \jac{\Dv^+}{\dv} &= \DR_{ij} & \jac{\Dv^+}{\dth} &= \bf0 \\
%\jac{\Dth^+}{\dpp} &= \bf0    & \jac{\Dth^+}{\dv} &= \bf0    & \jac{\Dth^+}{\dth} &= \bfI  
%~.
%\end{align*}
%
%We develop $\DTH_\dth$ as follows,
%%
%\begin{align*}
%\widetilde\DR_{ik} = \DR_{ik}\Exp(\partial\Dth_{ik}) 
%&= \DR_{ij}\widetilde\dR_{jk} \\
%&= \DR_{ij}\dR_{jk}\Exp(\partial\dth_{jk}) \\ 
%&= \DR_{ik}\Exp(\partial\dth_{jk}) 
%\end{align*}
%%
%which leads to
%%
%\begin{align*}
%\partial\Dth_{ik} &= \partial\dth_{jk}
%\end{align*}
%%
%therefore,
%%
%\begin{align}
%\DTH^+_\dth \te \dpar{\Dth_{ik}}{\dth_{jk}} = \bfI
%\end{align}





%\subsection{Jacobians of the direct integration}
%
%By chaining the three steps of computation of the body magnitudes, delta creation and delta composition, we encounter the Jacobians of the direct integration. The operations of direct integration are 
%%
%\begin{align*}
%\Dp_{ik} 
%&= \Dp_{ij} + \Dv_{ij}\dt + \frac12\Dq_{ij}\od(\bfa_{m,j}-\bfa_b)\dt^2 \\
%\Dv_{ik} 
%&= \Dv_{ij} + \Dq_{ij}\od(\bfa_{m,j}-\bfa_b)\dt \\
%\Dq_{ik} 
%&= \Dq_{ij}\ot\Exp((\bw_{m,j}-\bw_b, \dt)\dt) 
%\end{align*}
%%
%which boils down to
%%
%\begin{align*}
%\D_{ik} &= \D_{ij} \oplus \delta( (\bfa_{m,j}-\bfa_b), (\bw_{m,j}-\bw_b, \dt) )
%\end{align*}
%%
%
%\subsubsection{Jacobians \wrt the previous delta $\D_{ij}$}
%
%These are the ones detailed before, that we rewrite here,
%%
%\begin{align*}
%\DP^+_\Dp &= \bfI  & \DP^+_\Dv &= \bfI\dt & \DP^+_\Dth &= - \DR_{ij}  \hatx{\dpp_{jk}} \\
%\DV^+_\Dp &= \bf0  & \DV^+_\Dv &= \bfI & \DV^+_\Dth &= - \DR_{ij}  \hatx{\dv_{jk}}  \\
%\DTH^+_\Dp &= \bf0  & \DTH^+_\Dv &= \bf0 & \DTH^+_\Dth &= \dR_{jk}\tr 
%\end{align*}

\subsubsection{Jacobians \wrt noise}

The Jacobians \wrt the noise $\bfb_n=(\bfa_n,\bw_n)$ are obtained through the chain rule,
%
\begin{align}
\jac{\D^+}{\bfb_n} = \jac{\D^+}{\delta} \cdot \jac{\delta}{\bfb} \cdot \jac{\bfb}{\bfb_n} = \jac{\D^+}{\delta} \cdot \jac{\delta}{\bfb}
~.
\end{align}
%
%\begin{align*}
%%
%\DP^+_\bfa  &= \DP^+_\DP\DP_\bfa + \DP^+_\dP\dP_\bfa 
%& \DP^+_\bw &= \DP^+_\DP\DP_\bw + \DP^+_\dP\dP_\bw \\
%%
%\DV^+_\bfa  &= \DV^+_\DV\DV_\bfa + \DV^+_\dV \, \dV_\bfa
%& \DV^+_\bw &= \DV_\dv\,\dV_\bw = \bf0 \\
%%
%\DTH^+_\bfa  &= \bf0 
%& \DTH^+_\bw &= \DTH_\dth \, \dTH_\bw = \bfJ_r(\bw_j\dt)\dt 
%%
%\end{align*}
%%
%which results in
%%
%\begin{align*}
%%
%\DP^+_\bfa  &= \DP^+_\DP\DP_\bfa + \DP^+_\dP\dP_\bfa = \frac12\DR_{ij}\dt^2 
%& \DP^+_\bw &= \DP_\dpp\,\dP_\bw    = \bf0 \\
%%
%\DV^+_\bfa  &= \DV_\dv \, \dV_\bfa = \DR_{ij}\dt
%& \DV^+_\bw &= \DV_\dv\,\dV_\bw = \bf0 \\
%%
%\DTH^+_\bfa  &= \bf0 
%& \DTH^+_\bw &= \DTH_\dth \, \dTH_\bw = \bfJ_r(\bw_j\dt)\dt 
%%
%\end{align*}
%%


\subsubsection{Jacobians \wrt the biases}

The Jacobians \wrt the biases $\bfb_b=(\bfa_b,\bw_b)$ are obtained through the chain rule,
%
\begin{align}
\jac{\D^+}{\bfb_b} = \jac{\D^+}{\delta} \cdot \jac{\delta}{\bfb} \cdot \jac{\bfb}{\bfb_b} = - \jac{\D^+}{\delta} \cdot \jac{\delta}{\bfb}
~.
\end{align}




\subsection{Delta correction with new bias}

\subsubsection{Before integration}

Initialize the Jacobians
%
\begin{equation}
\DP_{\ab}|_{ii} = \DV_{\ab}|_{ii} = \DP_{\wb}|_{ii} = \DV_{\wb}|_{ii} = \DTH_{\bfw_b}|_{ii} = {\bf0}_{3\times3}
\end{equation}
%

\subsubsection{During integration}

Update the Jacobians,
%
\begin{align} 
\begin{split}
\DP_{\ab} |_{ik}
&= \DP_{\ab}|_{ij} + \DV_{\ab}|_{ij}\dt -\frac12\DR_{ij}\dt^2 \\
\DV_{\ab}|_{ik} 
&= \DV_{\ab}|_{ij} - \DR_{ij}\dt \\ 
\DP_{\wb} |_{ik}
&= \DP_{\wb}|_{ij} + \DV_{\wb}|_{ij}\dt -\frac12\DR_{ij}\hatx{\bfa_{mj}-\ab}\DTH_{\bfw_b}|_{ij}\,\dt^2 \\
\DV_{\wb}|_{ik} 
&= \DV_{\wb}|_{ij} - \DR_{ij}\hatx{\bfa_{mj}-\ab}\DTH_{\bfw_b}|_{ij}\,\dt \\
\DTH_{\bfw_b}|_{ik} 
&= \ol\dR_{jk}\tr\,\DTH_{\wb}|_{ij} - \bfJ_r((\bw_j-\ol\wb)\,\dt)\,\dt
\end{split}
\end{align}
%




\subsubsection{When using the Deltas}

Correct the Deltas according to variations in the bias estimates,
%
\begin{align}
\begin{split}
\Dp &= \ol\Dp + \DP_{\ab}\D\ab  + \DP_{\wb}\D\wb  \\ 
\Dv &= \ol\Dv + \DV_{\ab}\D\ab  + \DV_{\wb}\D\wb  \\
\Dq &= \ol\Dq\ot\Exp(\DTH_{\bfw_b}\D\wb)
\end{split}
\end{align}

\subsection{State reconstruction}

At any time $j$ we can recover the state estimate $\bfx_j$ given the state estimate $\bfx_i$ and the (corrected) delta $\D_{ij}$,
%
\begin{align} \label{equ:reconstruction}
\begin{split}
\bfp_j &= \bfp_i + \bfv_i\Dt_{ij} + \frac12\bfg\Dt_{ij}^2 + \bfq_i\od\Dp_{ij} \\
\bfv_j &= \bfv_i + \bfg\Dt_{ij} + \bfq_i\od\Dv_{ij} \\
\bfq_j &= \bfq_i\ot\Dq_{ij}   
\end{split}
\end{align}

\subsection{Residual}

We compare the corrected delta given the bias estimate $\hat\bfx_b$, against the predicted delta given two motion estimates $(\hat\bfx_i,\hat\bfx_j)$, and express it in minimal space,
%
\begin{align*}
\bfr_{ij}(\hat\bfx_i,\hat\bfx_j,\hat\bfx_{b,i}) = \tan\left( \Big(\ol\D_{ij} \oplus \dpar{\D_{ij}}{\bfx_b} (\hat\bfx_{b,i} - \ol\bfx_{b,i})\Big) \ominus \D_{ij}(\hat\bfx_i , \hat\bfx_j)  \right)
\end{align*}





%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newpage
\appendix

\section{Definition of the derivatives }

\subsection{The additive and subtractive operators in $SO(3)$}

In vector spaces $\bbR^n$, the addition and subtraction operations are performed with the regular sum `$+$' and minus `$-$' operations.
In $SO(3)$ this is not possible, but equivalent operators are needed for establishing a proper calculus corpus. 

We thus define the plus and minus operators, $\oplus,\ominus$, between elements $\sR\in SO(3)$, and elements $\bth\in\bbR^3$ of the tangent space at $\sR$, as follows.

\paragraph{The plus operator.}
The `plus' operator $\oplus:SO(3)\times\bbR^3\to SO(3)$ produces an element $\sS$ of $SO(3)$ which is the result of composing a reference element $\sR$ of $SO(3)$ with a (often small) rotation specified by a vector of $\bth\in\bbR^3$ in the vector space tangent to the reference element $\sR$,
%
\begin{align}
\sS = \sR\oplus \bth &\te \sR\circ\Exp(\bth) && \sR,\sS\in SO(3),~ \bth\in\bbR^3 
\end{align}
%
Notice that this operator may be defined for any representation of $SO(3)$. In particular, for the quaternion and rotation matrix we have,
%
\begin{align}
\bfq_\sS &= \,\bfq_\sR\oplus\bth = \bfq_\sR\ot\Exp(\bth) \\
\bfR_\cS &= \bfR_\sR\oplus \bth = \bfR_\sR\Exp(\bth) 
\end{align}

\paragraph{The minus operator.}
The `minus' operator $\ominus:SO(3)\times SO(3)\to\bbR^3$ is the inverse of the above. It returns the vectorial angular difference $\bth\in\bbR^3$ between two elements of $SO(3)$. This difference is expressed in the  vector space tangent to the reference element $\sR$, 
%
\begin{align}
\bth=\sS\ominus \sR
&\te \Log(\sR\inv \circ \sS)     && \sR,\sS\in SO(3),~ \bth\in\bbR^3  
\end{align}
%
which for the quaternion and rotation matrix reads,
%
\begin{align}
\bth &= \,\,\bfq_\sS\ominus\bfq_\sR\, = \Log(\bfq_\sR^*\ot\bfq_\sS)                      \\
\bth &= \bfR_\sS\ominus\bfR_\sR = \Log(\bfR_\sR\tr\,\bfR_\sS)                         
\end{align}

\bigskip
In both cases, notice that even though the vector difference $\bftheta$ is typically supposed to be small, the definitions above hold for any value of $\bftheta$ (up to the first coverage of the $SO(3)$ manifold, that is, for angles $\theta<\pi$).

\subsection{The four possible derivative definitions}



\subsubsection{Functions from vector space to vector space}

The scalar and vector cases follow the classical definition of the derivative: given a function $f:\bbR^m\to\bbR^n$, we use $\{+,-\}$ to define the derivative as
%
\begin{align}
\dpar{f(\bfx)}{\bfx} &\te \lim_{\delta\bfx\to0}\frac{f(\bfx+\delta\bfx)-f(\bfx)}{\delta\bfx} &&\in \bbR^{n\times m} \label{equ:derivative_vector}
\end{align}
%
Euler integration produces linear expressions of the form
%
\begin{align*}
f(\bfx+\Delta\bfx) &\approx f(\bfx) + \dpar{f(\bfx)}{\bfx}\Delta\bfx
& \in \bbR^n
\end{align*}

\subsubsection{Functions from $SO(3)$ to $SO(3)$}

Given a function $f:SO(3) \to SO(3)$ with $\sR\in SO(3)$ and a local, small angular variation $\bth\in\bbR^3$, we use $\{\oplus,\ominus\}$ to define the derivative as
%
\begin{align}
\dpar{f(\sR)}{\bth} 
&\te \lim_{\delta\bth\to0}\frac{f(\sR\oplus\delta\bth)\ominus f(\sR)}{\delta\bth}  && \in \bbR^{3\times 3}\\
&= \lim_{\delta\bth\to0}\frac{\Log\big(f\inv(\sR)\,f(\sR\Exp(\delta\bth))\big)}{\delta\bth} \label{equ:derivative_SO3}
\end{align}
%
Euler integration produces expressions of the form,
%
\begin{align*}
f(\sR\oplus\Delta\bth) &\approx f(\sR)\,\oplus\,\dpar{f(\sR)}{\bth}\,\Delta\bth
 \te f(\sR)\Exp\left(\dpar{f(\sR)}{\bth}\Delta\bth\right)
 & \in SO(3)
\end{align*}




\subsubsection{Functions from vector space to $SO(3)$}

For the case of a function $f:\bbR^m\to SO(3)$, we use `+' for the vector perturbations, and `$\ominus$' for the $SO(3)$ difference,
%
\begin{align}
\dpar{f(\bfx)}{\bfx} &\te \lim_{\delta\bfx\to0} \frac{ f(\bfx+\delta\bfx)\ominus f(\bfx)}{\delta\bfx} && \in \bbR^{3\times m} \label{equ:dif_RtoSO3}\\
&= \lim_{\delta\bfx\to0} \frac{\Log(f\inv(\bfx) f(\bfx+\delta\bfx))}{\delta\bfx}
\end{align}
%
Euler integration produces expressions of the form,
%
\begin{align*}
f(\bfx+\Delta\bfx) &\approx f(\bfx)\,\oplus\,\dpar{f(\bfx)}{\bfx}\,\Delta\bfx
 \te f(\bfx)\,\Exp\left(\dpar{f(\bfx)}{\bfx}\Delta\bfx\right)
 & \in SO(3)
\end{align*}

\subsubsection{Functions from $SO(3)$ to vector space}

For the case of a function $f: SO(3)\to\bbR^n$, we use `$\oplus$' for the $SO(3)$ perturbations, and `$-$' for the vector difference,
%
\begin{align}
\dpar{f(\sR)}{\bth} &\te \lim_{\delta\bth\to0} \frac{f(\sR\oplus\delta\bth) - f(\sR)}{\delta\bth} && \in \bbR^{n\times 3} \label{equ:jacobian_SO3_Rn}\\
&= \lim_{\delta\bth\to0} \frac{f(\sR\Exp(\delta\bth)) - f(\sR)}{\delta\bth}
\end{align}
%
Euler integration produces expressions of the form,
%
\begin{align*}
f(\sR\oplus\delta\bth) &\approx f(\sR)+\dpar{f(\sR)}{\bth}\,\Delta\bth
 \te f(\sR)+\Exp\left(\dpar{f(\sR)}{\bth}\Delta\bth\right)
 & \in SO(3)
\end{align*}


\subsection{Right Jacobian of $SO(3)$ }

We define the right Jacobian of $SO(3)$ as, 
%
\begin{align}
\bfJ_r(\bth) &\te \dpar{\Exp(\bth)}{\bth} 
\end{align}
%
Since the exponential $\Exp()$ is an application $\bbR^3\to SO(3)$,
we implement this derivative using \eqRef{equ:dif_RtoSO3},
%
\begin{align}
\bfJ_r(\bth) &= \lim_{\dth\to0}\frac{\Exp(\bth+\dth)\ominus\Exp(\bth)}{\dth} \\
 &= \lim_{\dth\to0}\frac{\Log(\Exp(\bth)\tr\Exp(\bth+\dth))}{\dth} && \textrm{if using $\bfR$} \\
 &= \lim_{\dth\to0}\frac{\Log(\Exp(\bth)^*\ot\Exp(\bth+\dth))}{\dth} && \textrm{if using $\bfq$} 
 ~.
\end{align}
%
It has the properties, for any $\bth$ and small $\dth$,
%
\begin{align}
\Exp(\bth+\dth) &\approx \Exp(\bth)\Exp(\bfJ_r(\bth)\dth) \\
\Exp(\bth)\Exp(\dth) &\approx \Exp(\bth+\bfJ_r\inv(\bth)\,\dth) \\
\Log(\Exp(\bth)\Exp(\dth)) &\approx \bth+\bfJ_r\inv(\bth)\,\dth 
\end{align}

The right Jacobian and its inverse can be computed in closed form with
%
\begin{align}
\bfJ_r(\bth) &= \bfI - \frac{1-\cos\nth}{\nth^2}\hatx{\bth} + \frac{\nth-\sin\nth}{\nth^3}\hatx{\bth}^2 \\
\bfJ_r\inv(\bth) &= \bfI + \frac12\hatx{\bth} + \left(\frac1{\nth^2} - \frac{1+\cos\nth}{2\nth\sin\nth}\right)\hatx{\bth}^2
\end{align}






%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newpage
\section{Rules, do's and don'ts for Jacobians}
\label{sec:DosDonts}

We provide a collection of rules which come very handy to develop Jacobians. They come organized under helper \com{keys}\!\!\!\!, which we use to refer to each of these properties in our developments.

\subsection{Useful properties: Do's}

\paragraph{\cchain : Chain rule}

\begin{align}
\dpar{\bfz}{\bfx} = \dpar{\bfz}{\bfy}\cdot\dpar{\bfy}{\bfx}
\end{align}

\paragraph{\ccross : Cross product and skew-symmetric matrix}

\begin{align}
\hatx{\bfa}\bfb &= \bfa\times\bfb \\
\hatx{\bfa}\bfb &= -\hatx{\bfb}\bfa \\
\bfR\tr\hatx{\bfR\bfa}\bfR &= \hatx{\bfa} \\
\hatx{\bfR\bfa} &= \bfR\hatx{\bfa}\bfR\tr 
\end{align}

\paragraph{\cJr : Right Jacobian of $SO(3)$ }

It has the properties, for any $\bth$ and small $\dth$,
%
\begin{align}
\Exp(\bth+\dth) &\approx \Exp(\bth)\Exp(\bfJ_r(\bth)\dth) \\
\Exp(\bth)\Exp(\dth) &\approx \Exp(\bth+\bfJ_r\inv(\bth)\,\dth) \\
\Log(\Exp(\bth)\Exp(\dth)) &\approx \bth+\bfJ_r\inv(\bth)\dth %\\
\end{align}
%






\paragraph{\csmall : Small angle approximations}

Let $\dth$ be a small angle vector. Then,
%
\begin{align}
\Exp(\dth) &\approx \bfI + \hatx{\dth} \\
\Exp(\dth)\tr &\approx \bfI - \hatx{\dth} \\
\Exp(\dth_1)\Exp(\dth_2) &\approx \Exp(\dth_1+\dth_2) \\
\textstyle\prod_i \Exp(\dth_i) &\approx \Exp\!\big(\textstyle\sum_i\dth_i\big) \\
\bfJ_r(\dth) &\approx \bfI - \frac12\hatx{\dth} \\
\bfJ_r\inv(\dth) &\approx \bfI + \frac12\hatx{\dth} 
\end{align}
%
Example: we often use $\Exp(\bfJ_r(\bth)\dth)\approx \bfI + \hatx{\bfJ_r(\bth)\dth}$.

\paragraph{\cswap : Reversing product order}

Since $$\bfR\Exp(\bth)\bfR\tr=\bfR\exp(\hatx{\bth})\bfR\tr=\exp(\bfR\hatx{\bth}\bfR\tr)=\exp(\hatx{\bfR\bth})=\Exp(\bfR\bth),$$ then
%
\begin{align}
\Exp(\bth)\bfR &= \bfR\Exp(\bfR\tr\bth) \\
\bfR\tr\Exp(\bth)\bfR &= \Exp(\bfR\tr\bth) \\
\Exp(\bth)\Exp(\bphi) &= \Exp(\bphi)\Exp(\Exp(\bphi)\tr\bth) 
\end{align}


\paragraph{\cexpand, \csubst, \ccancel : Expand, substitute, cancel :} This happens when we expand or substitute a previously defined term, or when we cancel terms.

\paragraph{\tcom{$\oplus$}, \tcom{$\ominus$}, \tcom{(1)} : Apply definition :} This happens when we apply a particular definition or equation number.

\subsection{Common mistakes: Don'ts}

\begin{align}
\Exp(\bth_1+\bth_2) &\ne \Exp(\bth_1)\Exp(\bth_2) \\
\Log(\bfR_1\bfR_2) &\ne \Log(\bfR_1) + \Log(\bfR_2) \\
\bfJ_r(\bth) &\ne \bfI - \frac12\hatx{\bth} \\
\bfJ_r\inv(\bth) &\ne \bfI + \frac12\hatx{\bth} 
\end{align}
%
however, these hold approximately true for small angle vectors. See \csmall above.


\subsection{Examples}

\subsubsection{Example 1: $\bbR^3\times\bbR^3\to\bbR^3$} 

The rotation $f(\bth,\bfv) = \bfR(\bth)\,\bfv = \Exp(\bth)\,\bfv \in \bbR^3$ produces vectors of $\bbR^3$ from vectors $\bth,\bfv$ in $\bbR^3$. Its Jacobians are defined by \eqRef{equ:derivative_vector} and developed as
%
\begin{align*}
\dpar{\bfR(\bth)\bfv}{\bth} 
&= \lim_{\delta\bth\to0}\frac{\Exp(\bth+\delta\bth)\bfv-\Exp(\bth)\bfv}{\delta\bth} \\
\cJr
&= \lim_{\delta\bth\to0}\frac{\Exp(\bth)\Exp(\bfJ_r(\bth)\delta\bth)\bfv-\Exp(\bth)\bfv}{\delta\bth} \\
\csmall
&= \lim_{\delta\bth\to0}\frac{\Exp(\bth)(\bfI+\hatx{\bfJ_r(\bth)\delta\bth})\bfv-\Exp(\bth)\bfv}{\delta\bth} \\
\ccancel
&= \lim_{\delta\bth\to0}\frac{\Exp(\bth)\hatx{\bfJ_r(\bth)\delta\bth}\bfv}{\delta\bth} \\
\ccross
&= \lim_{\delta\bth\to0}\frac{-\Exp(\bth)\hatx{\bfv}\bfJ_r(\bth)\delta\bth}{\delta\bth} \\
&= -\bfR(\bth)\hatx{\bfv}\bfJ_r(\bth) 
\end{align*}
%
and
%
\begin{align*}
\dpar{\bfR(\bth)\bfv}{\bfv} 
&= \lim_{\partial\bfv\to0}\frac{\bfR(\bth)(\bfv+\partial\bfv)-\bfR(\bth)\bfv}{\partial\bfv} \\
\com{cancel} 
&= \bfR(\bth)
\end{align*}

\subsubsection{Example 2: $SO(3)\times\bbR^3\to\bbR^3$} 

The rotation $f(\bfR,\bfv) = \bfR\,\bfv \in \bbR^3$ produces vectors of $\bbR^3$ from elements $\bfR\in SO(3)$ and vectors in $\bbR^3$. The first Jacobian is defined by \eqRef{equ:jacobian_SO3_Rn} and developed as
%
\begin{align*}
\dpar{\bfR\bfv}{\bth} 
&\te \lim_{\delta\bth\to0}\frac{(\bfR\oplus\delta\bth)\bfv-\bfR\bfv}{\delta\bth} \\
\com{$\oplus$}
&= \lim_{\delta\bth\to0}\frac{\bfR\Exp(\delta\bth)\bfv-\bfR\bfv}{\delta\bth} \\
\csmall
&= \lim_{\delta\bth\to0}\frac{\bfR\tdot(\bfI+\hatx{\delta\bth})\bfv-\bfR\bfv}{\delta\bth} \\
\ccancel
&= \lim_{\delta\bth\to0}\frac{\bfR\hatx{\delta\bth}\bfv}{\delta\bth} \\
\ccross
&= \lim_{\delta\bth\to0}\frac{-\bfR\hatx{\bfv}\delta\bth}{\delta\bth} \\
&= -\bfR\hatx{\bfv} 
\end{align*}
%
The second Jacobian is defined by \eqRef{equ:derivative_vector} and trivially develops as,
%
\begin{align*}
\dpar{\bfR\bfv}{\bfv} 
&\te \lim_{\partial\bfv\to0}\frac{\bfR\tdot(\bfv+\partial\bfv)-\bfR\bfv}{\partial\bfv} \\
&= \bfR
\end{align*}

\subsubsection{Example 3: $SO(3)\times\bbR^3\to SO(3)$} 

The function $f(\bfR,\bw) = \bfR\Exp(\bw\dt)\in SO(3)$ produces elements of $SO(3)$ from elements in $SO(3)$ and vectors $\bw$ in $\bbR^3$. Its Jacobians are 
%
\begin{align*}
\dpar{\bfR\Exp(\bw\dt)}{\bth} 
&= \lim_{\delta\bth\to0}\frac{(\bfR\oplus\delta\bth)\Exp(\bw\dt)\ominus(\bfR\Exp(\bw\dt))}{\delta\bth} \\
\com{$\oplus,\ominus$}
&= \lim_{\delta\bth\to0}\frac{\Log\big((\bfR\Exp(\bw\dt))\inv \bfR\Exp(\delta\bth)\Exp(\bw\dt)\big)}{\delta\bth} \\
&= \lim_{\delta\bth\to0}\frac{\Log\big(\Exp(\bw\dt)\tr\bfR\tr \bfR\Exp(\delta\bth)\Exp(\bw\dt)\big)}{\delta\bth} \\
\ccancel
&= \lim_{\delta\bth\to0}\frac{\Log\big(\Exp(\bw\dt)\tr\Exp(\delta\bth)\Exp(\bw\dt)\big)}{\delta\bth} \\
\cswap
&= \lim_{\delta\bth\to0}\frac{\Log\big(\Exp(\Exp(\bw\dt)\tr\delta\bth)\big)}{\delta\bth} \\
\ccancel
&= \lim_{\delta\bth\to0}\frac{\Exp(\bw\dt)\tr\delta\bth}{\delta\bth} \\
&= \Exp(-\bw\dt) 
\end{align*}
%
and
%
\begin{align*}
\dpar{\bfR\Exp(\bw\dt)}{\bw} 
&= \lim_{\delta\bw\to0}\frac{\bfR\Exp((\bw+\delta\bw)\dt) \ominus (\bfR\Exp(\bw\dt)) }{\delta\bw} \\
\com{$\ominus$}
&= \lim_{\delta\bw\to0}\frac{\Log\big((\bfR\Exp(\bw\dt))\inv \, \bfR\Exp(\bw\dt+\delta\bw\dt)\big)}{\delta\bw} \\
\cJr
&= \lim_{\delta\bw\to0}\frac{\Log\big((\bfR\Exp(\bw\dt))\inv \bfR\Exp(\bw\dt)\Exp(\bfJ_r(\bw\dt)\delta\bw\dt)\big)}{\delta\bw} \\
\ccancel
&= \lim_{\delta\bw\to0}\frac{\Log\big(\Exp(\bfJ_r(\bw\dt)\delta\bw\dt)\big)}{\delta\bw} \\
\com{cancel}
&= \bfJ_r(\bw\dt)\dt
\end{align*}
%
%This can be seen in a easier way using the chain rule on $\bw\dt$,
%%
%\begin{align*}
%\dpar{\bfR\Exp(\bw\dt)}{\bw} 
%&= \dpar{\bfR\Exp(\bw\dt)}{\bw\dt}\dpar{\bf\dt}{\bw} \\
%&= \dpar{\bfR\Exp(\bw\dt)}{\bw\dt}\dt \\
%\cJr
%&= \bfJ_r(\bw\dt)\dt
%\end{align*}
%
Refer to the text for other developments, \eg~\secRef{sec:jac_first_delta}.



\subsubsection{Example 4: $SO(3)\times SO(3)\to SO(3)$}

The function $f(\bfR,\bfS) = \bfR\{\bftheta\}\,\bfS\{\bfphi\} \in SO(3)$ produces the concatenation of rotations, or rotation composition. Its Jacobians are
%
\begin{align*}
\dpar{\bfR\{\bftheta\}\,\bfS\{\bfphi\}}{\bftheta} 
&= \lim_{\delta\bftheta\to0}\frac{\Log\big((\bfR\bfS)\inv((\bfR\oplus\delta\bftheta)\bfS)\big)}{\delta\bftheta} \\
&= \lim_{\delta\bftheta\to0}\frac{\Log\big((\bfR\bfS)\tr(\bfR\Exp(\delta\bftheta)\bfS)\big)}{\delta\bftheta} \\
&= \lim_{\delta\bftheta\to0}\frac{\Log\big(\bfS\tr\bfR\tr\bfR\Exp(\delta\bftheta)\bfS\big)}{\delta\bftheta} \\
&= \lim_{\delta\bftheta\to0}\frac{\Log\big(\bfS\tr\Exp(\delta\bftheta)\bfS\big)}{\delta\bftheta} \\
\cswap
&= \lim_{\delta\bftheta\to0}\frac{\Log\big(\Exp(\bfS\tr\delta\bftheta)\big)}{\delta\bftheta} \\
&= \lim_{\delta\bftheta\to0}\frac{\bfS\tr\delta\bftheta}{\delta\bftheta} \\
&= \bfS\tr
\end{align*}
%
and
%
\begin{align*}
\dpar{\bfR\{\bftheta\}\,\bfS\{\bfphi\}}{\bfphi} 
&= \lim_{\delta\bfphi\to0}\frac{\Log\big((\bfR\bfS)\tr(\bfR(\bfS\oplus\delta\bfphi))\big)}{\delta\bfphi} \\
&= \lim_{\delta\bfphi\to0}\frac{\Log\big((\bfR\bfS)\tr(\bfR\bfS\Exp(\delta\bfphi))\big)}{\delta\bfphi} \\
&= \lim_{\delta\bfphi\to0}\frac{\Log\big(\Exp(\delta\bfphi)\big)}{\delta\bfphi} \\
&= \lim_{\delta\bfphi\to0}\frac{\delta\bfphi}{\delta\bfphi} \\
&= \bfI
\end{align*}





\section{Uncertainties in $SO(3)$}

\subsection{Description of uncertainty}
\subsubsection{Vector spaces}
\begin{align*}
\widetilde\bfx&=\bfx+\delta\bfx
\end{align*}
\subsubsection{$SO(3)$}
\begin{align*}
\widetilde\bfR&=\bfR\oplus\dth\te\bfR\Exp(\delta\bth) \\
\widetilde\bfq&=\bfq\oplus\dth\te\bfq\ot\Exp(\delta\bth)
\end{align*}

\subsection{Uncertainty propagation}

%
The uncertainty of the composition of two uncertain elements of $SO(3)$ can be derived as follows (we use the matrix form for convenience),
%
\begin{align*}
\widetilde\bfR = \bfR\Exp(\dth) 
&= \widetilde{\bfR_1\bfR_2} \\
&= \widetilde\bfR_1\widetilde\bfR_2 \\
\cexpand
&= \bfR_1\Exp(\dth_1)\bfR_2\Exp(\dth_2) \\
\cswap
&= \bfR_1\bfR_2\Exp(\bfR_2\tr\dth_1)\Exp(\dth_2) \\
\cJr
&\approx \bfR_1\bfR_2\Exp(\bfR_2\tr\dth_1+\bfJ_r\inv(\bfR_2\tr\dth_1)\dth_2) \\
&= \bfR\Exp(\bfR_2\tr\dth_1+\bfJ_r\inv(\bfR_2\tr\dth_1)\dth_2) 
\end{align*}
%
and therefore,
%
\begin{align}
\dth = \bfR_2\tr\dth_1+\bfJ_r\inv(\bfR_2\tr\dth_1)\dth_2
\end{align}
%
We can derive equivalent Jacobian matrices for the propagation. Since each partial derivative assumes null perturbations in  other variables, we have,
%
\begin{align}
\DTH_{\dth_1} \te \dpar{\bth}{\bth_1} &= \frac{\dth(\dth_2=0)}{\dth_1} = \bfR_2\tr \\
\DTH_{\dth_2} \te \dpar{\bth}{\bth_2} &= \frac{\dth(\dth_1=0)}{\dth_2} = \bfI
\end{align}
%
yielding
%
\begin{align}
\dth \approx \bfR_2\tr\dth_1+\dth_2
\end{align}
%
which constitutes a regular frame transformation operation. The covariances are propagated from $\bfR_1$ and $\bfR_2$ to $\bfR$ as 
%
\begin{align*}
\Sigma = \bfR_2\tr\,\Sigma_1\,\bfR_2 + \Sigma_2
\end{align*}

