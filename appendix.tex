% !TEX root = main.tex

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\appendix

\section{Definition of the derivatives }

\subsection{The additive and subtractive operators in $SO(3)$}

In vector spaces $\bbR^n$, the addition and subtraction operations are performed with the regular sum `$+$' and minus `$-$' operations.
In $SO(3)$ this is not possible, but equivalent operators are needed for establishing a proper calculus corpus. 

We thus define the plus and minus operators, $\oplus,\ominus$, between elements $\sR\in SO(3)$, and elements $\bth\in\bbR^3$ of the tangent space at $\sR$, as follows.

\paragraph{The plus operator.}
The `plus' operator $\oplus:SO(3)\times\bbR^3\to SO(3)$ produces an element $\sS$ of $SO(3)$ which is the result of composing a reference element $\sR$ of $SO(3)$ with a (often small) rotation specified by a vector of $\bth\in\bbR^3$ in the vector space tangent to the reference element $\sR$,
%
\begin{align}
\sS = \sR\oplus \bth &\te \sR\circ\Exp(\bth) && \sR,\sS\in SO(3),~ \bth\in\bbR^3 
\end{align}
%
Notice that this operator may be defined for any representation of $SO(3)$. In particular, for the quaternion and rotation matrix we have,
%
\begin{align}
\bfq_\sS &= \,\bfq_\sR\oplus\bth = \bfq_\sR\ot\Exp(\bth) \\
\bfR_\cS &= \bfR_\sR\oplus \bth = \bfR_\sR\Exp(\bth) 
\end{align}

\paragraph{The minus operator.}
The `minus' operator $\ominus:SO(3)\times SO(3)\to\bbR^3$ is the inverse of the above. It returns the vectorial angular difference $\bth\in\bbR^3$ between two elements of $SO(3)$. This difference is expressed in the  vector space tangent to the reference element $\sR$, 
%
\begin{align}
\bth=\sS\ominus \sR
&\te \Log(\sR\inv \circ \sS)     && \sR,\sS\in SO(3),~ \bth\in\bbR^3  
\end{align}
%
which for the quaternion and rotation matrix reads,
%
\begin{align}
\bth &= \,\,\bfq_\sS\ominus\bfq_\sR\, = \Log(\bfq_\sR^*\ot\bfq_\sS)                      \\
\bth &= \bfR_\sS\ominus\bfR_\sR = \Log(\bfR_\sR\tr\,\bfR_\sS)                         
\end{align}

\bigskip
In both cases, notice that even though the vector difference $\bftheta$ is typically supposed to be small, the definitions above hold for any value of $\bftheta$ (up to the first coverage of the $SO(3)$ manifold, that is, for angles $\theta<\pi$).

\subsection{The four possible derivative definitions}



\subsubsection{Functions from vector space to vector space}

The scalar and vector cases follow the classical definition of the derivative: given a function $f:\bbR^m\to\bbR^n$, we use $\{+,-\}$ to define the derivative as
%
\begin{align}
\dpar{f(\bfx)}{\bfx} &\te \lim_{\delta\bfx\to0}\frac{f(\bfx+\delta\bfx)-f(\bfx)}{\delta\bfx} &&\in \bbR^{n\times m} \label{equ:derivative_vector}
\end{align}
%
Euler integration produces linear expressions of the form
%
\begin{align*}
f(\bfx+\Delta\bfx) &\approx f(\bfx) + \dpar{f(\bfx)}{\bfx}\Delta\bfx
& \in \bbR^n
\end{align*}

\subsubsection{Functions from $SO(3)$ to $SO(3)$}

Given a function $f:SO(3) \to SO(3)$ with $\sR\in SO(3)$ and a local, small angular variation $\bth\in\bbR^3$, we use $\{\oplus,\ominus\}$ to define the derivative as
%
\begin{align}
\dpar{f(\sR)}{\bth} 
&\te \lim_{\delta\bth\to0}\frac{f(\sR\oplus\delta\bth)\ominus f(\sR)}{\delta\bth}  && \in \bbR^{3\times 3}\\
&= \lim_{\delta\bth\to0}\frac{\Log\big(f\inv(\sR)\,f(\sR\Exp(\delta\bth))\big)}{\delta\bth} \label{equ:derivative_SO3}
\end{align}
%
Euler integration produces expressions of the form,
%
\begin{align*}
f(\sR\oplus\Delta\bth) &\approx f(\sR)\,\oplus\,\dpar{f(\sR)}{\bth}\,\Delta\bth
 \te f(\sR)\Exp\left(\dpar{f(\sR)}{\bth}\Delta\bth\right)
 & \in SO(3)
\end{align*}




\subsubsection{Functions from vector space to $SO(3)$}

For the case of a function $f:\bbR^m\to SO(3)$, we use `+' for the vector perturbations, and `$\ominus$' for the $SO(3)$ difference,
%
\begin{align}
\dpar{f(\bfx)}{\bfx} &\te \lim_{\delta\bfx\to0} \frac{ f(\bfx+\delta\bfx)\ominus f(\bfx)}{\delta\bfx} && \in \bbR^{3\times m} \label{equ:dif_RtoSO3}\\
&= \lim_{\delta\bfx\to0} \frac{\Log(f\inv(\bfx) f(\bfx+\delta\bfx))}{\delta\bfx}
\end{align}
%
Euler integration produces expressions of the form,
%
\begin{align*}
f(\bfx+\Delta\bfx) &\approx f(\bfx)\,\oplus\,\dpar{f(\bfx)}{\bfx}\,\Delta\bfx
 \te f(\bfx)\,\Exp\left(\dpar{f(\bfx)}{\bfx}\Delta\bfx\right)
 & \in SO(3)
\end{align*}

\subsubsection{Functions from $SO(3)$ to vector space}

For the case of a function $f: SO(3)\to\bbR^n$, we use `$\oplus$' for the $SO(3)$ perturbations, and `$-$' for the vector difference,
%
\begin{align}
\dpar{f(\sR)}{\bth} &\te \lim_{\delta\bth\to0} \frac{f(\sR\oplus\delta\bth) - f(\sR)}{\delta\bth} && \in \bbR^{n\times 3} \label{equ:jacobian_SO3_Rn}\\
&= \lim_{\delta\bth\to0} \frac{f(\sR\Exp(\delta\bth)) - f(\sR)}{\delta\bth}
\end{align}
%
Euler integration produces expressions of the form,
%
\begin{align*}
f(\sR\oplus\delta\bth) &\approx f(\sR)+\dpar{f(\sR)}{\bth}\,\Delta\bth
 \te f(\sR)+\Exp\left(\dpar{f(\sR)}{\bth}\Delta\bth\right)
 & \in SO(3)
\end{align*}


\subsection{Right Jacobian of $SO(3)$ }

We define the right Jacobian of $SO(3)$ as, 
%
\begin{align}
\bfJ_r(\bth) &\te \dpar{\Exp(\bth)}{\bth} 
\end{align}
%
Since the exponential $\Exp()$ is an application $\bbR^3\to SO(3)$,
we implement this derivative using \eqRef{equ:dif_RtoSO3},
%
\begin{align}
\bfJ_r(\bth) &= \lim_{\dth\to0}\frac{\Exp(\bth+\dth)\ominus\Exp(\bth)}{\dth} \\
 &= \lim_{\dth\to0}\frac{\Log(\Exp(\bth)\tr\Exp(\bth+\dth))}{\dth} && \textrm{if using $\bfR$} \\
 &= \lim_{\dth\to0}\frac{\Log(\Exp(\bth)^*\ot\Exp(\bth+\dth))}{\dth} && \textrm{if using $\bfq$} 
 ~.
\end{align}
%
It has the properties, for any $\bth$ and small $\dth$,
%
\begin{align}
\Exp(\bth+\dth) &\approx \Exp(\bth)\Exp(\bfJ_r(\bth)\dth) \\
\Exp(\bth)\Exp(\dth) &\approx \Exp(\bth+\bfJ_r\inv(\bth)\,\dth) \\
\Log(\Exp(\bth)\Exp(\dth)) &\approx \bth+\bfJ_r\inv(\bth)\,\dth 
\end{align}

The right Jacobian and its inverse can be computed in closed form with
%
\begin{align}
\bfJ_r(\bth) &= \bfI - \frac{1-\cos\nth}{\nth^2}\hatx{\bth} + \frac{\nth-\sin\nth}{\nth^3}\hatx{\bth}^2 \\
\bfJ_r\inv(\bth) &= \bfI + \frac12\hatx{\bth} + \left(\frac1{\nth^2} - \frac{1+\cos\nth}{2\nth\sin\nth}\right)\hatx{\bth}^2
\end{align}






%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Rules, do's and don'ts for Jacobians}
\label{sec:DosDonts}

We provide a collection of rules which come very handy to develop Jacobians. They come organized under helper \com{keys}\!\!\!\!, which we use to refer to each of these properties in our developments.

\subsection{Useful properties: Do's}

\paragraph{\cchain : Chain rule}

\begin{align}
\dpar{\bfz}{\bfx} = \dpar{\bfz}{\bfy}\cdot\dpar{\bfy}{\bfx}
\end{align}

\paragraph{\ccross : Cross product and skew-symmetric matrix}

\begin{align}
\hatx{\bfa}\bfb &= \bfa\times\bfb \\
\hatx{\bfa}\bfb &= -\hatx{\bfb}\bfa \\
\bfR\tr\hatx{\bfR\bfa}\bfR &= \hatx{\bfa} \\
\hatx{\bfR\bfa} &= \bfR\hatx{\bfa}\bfR\tr 
\end{align}

\paragraph{\cJr : Right Jacobian of $SO(3)$ }

It has the properties, for any $\bth$ and small $\dth$,
%
\begin{align}
\Exp(\bth+\dth) &\approx \Exp(\bth)\Exp(\bfJ_r(\bth)\dth) \\
\Exp(\bth)\Exp(\dth) &\approx \Exp(\bth+\bfJ_r\inv(\bth)\,\dth) \\
\Log(\Exp(\bth)\Exp(\dth)) &\approx \bth+\bfJ_r\inv(\bth)\dth %\\
\end{align}
%






\paragraph{\csmall : Small angle approximations}

Let $\dth$ be a small angle vector. Then,
%
\begin{align}
\Exp(\dth) &\approx \bfI + \hatx{\dth} \\
\Exp(\dth)\tr &\approx \bfI - \hatx{\dth} \\
\Exp(\dth_1)\Exp(\dth_2) &\approx \Exp(\dth_1+\dth_2) \\
\textstyle\prod_i \Exp(\dth_i) &\approx \Exp\!\big(\textstyle\sum_i\dth_i\big) \\
\bfJ_r(\dth) &\approx \bfI - \frac12\hatx{\dth} \\
\bfJ_r\inv(\dth) &\approx \bfI + \frac12\hatx{\dth} 
\end{align}
%
Example: we often use $\Exp(\bfJ_r(\bth)\dth)\approx \bfI + \hatx{\bfJ_r(\bth)\dth}$.

\paragraph{\cswap : Reversing product order}

Since $$\bfR\Exp(\bth)\bfR\tr=\bfR\exp(\hatx{\bth})\bfR\tr=\exp(\bfR\hatx{\bth}\bfR\tr)=\exp(\hatx{\bfR\bth})=\Exp(\bfR\bth),$$ then
%
\begin{align}
\Exp(\bth)\bfR &= \bfR\Exp(\bfR\tr\bth) \\
\bfR\tr\Exp(\bth)\bfR &= \Exp(\bfR\tr\bth) \\
\Exp(\bth)\Exp(\bphi) &= \Exp(\bphi)\Exp(\Exp(\bphi)\tr\bth) 
\end{align}


\paragraph{\cexpand, \csubst, \ccancel : Expand, substitute, cancel :} This happens when we expand or substitute a previously defined term, or when we cancel terms.

\paragraph{\tcom{$\oplus$}, \tcom{$\ominus$}, \tcom{(1)} : Apply definition :} This happens when we apply a particular definition or equation number.

\subsection{Common mistakes: Don'ts}

\begin{align}
\Exp(\bth_1+\bth_2) &\ne \Exp(\bth_1)\Exp(\bth_2) \\
\Log(\bfR_1\bfR_2) &\ne \Log(\bfR_1) + \Log(\bfR_2) \\
\bfJ_r(\bth) &\ne \bfI - \frac12\hatx{\bth} \\
\bfJ_r\inv(\bth) &\ne \bfI + \frac12\hatx{\bth} 
\end{align}
%
however, these hold approximately true for small angle vectors. See \csmall above.


\subsection{Examples}

\subsubsection{Example 1: $\bbR^3\times\bbR^3\to\bbR^3$} 

The rotation $f(\bth,\bfv) = \bfR(\bth)\,\bfv = \Exp(\bth)\,\bfv \in \bbR^3$ produces vectors of $\bbR^3$ from vectors $\bth,\bfv$ in $\bbR^3$. Its Jacobians are defined by \eqRef{equ:derivative_vector} and developed as
%
\begin{align*}
\dpar{\bfR(\bth)\bfv}{\bth} 
&= \lim_{\delta\bth\to0}\frac{\Exp(\bth+\delta\bth)\bfv-\Exp(\bth)\bfv}{\delta\bth} \\
\cJr
&= \lim_{\delta\bth\to0}\frac{\Exp(\bth)\Exp(\bfJ_r(\bth)\delta\bth)\bfv-\Exp(\bth)\bfv}{\delta\bth} \\
\csmall
&= \lim_{\delta\bth\to0}\frac{\Exp(\bth)(\bfI+\hatx{\bfJ_r(\bth)\delta\bth})\bfv-\Exp(\bth)\bfv}{\delta\bth} \\
\ccancel
&= \lim_{\delta\bth\to0}\frac{\Exp(\bth)\hatx{\bfJ_r(\bth)\delta\bth}\bfv}{\delta\bth} \\
\ccross
&= \lim_{\delta\bth\to0}\frac{-\Exp(\bth)\hatx{\bfv}\bfJ_r(\bth)\delta\bth}{\delta\bth} \\
&= -\bfR(\bth)\hatx{\bfv}\bfJ_r(\bth) 
\end{align*}
%
and
%
\begin{align*}
\dpar{\bfR(\bth)\bfv}{\bfv} 
&= \lim_{\partial\bfv\to0}\frac{\bfR(\bth)(\bfv+\partial\bfv)-\bfR(\bth)\bfv}{\partial\bfv} \\
\com{cancel} 
&= \bfR(\bth)
\end{align*}

\subsubsection{Example 2: $SO(3)\times\bbR^3\to\bbR^3$} 

The rotation $f(\bfR,\bfv) = \bfR\,\bfv \in \bbR^3$ produces vectors of $\bbR^3$ from elements $\bfR\in SO(3)$ and vectors in $\bbR^3$. The first Jacobian is defined by \eqRef{equ:jacobian_SO3_Rn} and developed as
%
\begin{align*}
\dpar{\bfR\bfv}{\bth} 
&\te \lim_{\delta\bth\to0}\frac{(\bfR\oplus\delta\bth)\bfv-\bfR\bfv}{\delta\bth} \\
\com{$\oplus$}
&= \lim_{\delta\bth\to0}\frac{\bfR\Exp(\delta\bth)\bfv-\bfR\bfv}{\delta\bth} \\
\csmall
&= \lim_{\delta\bth\to0}\frac{\bfR\tdot(\bfI+\hatx{\delta\bth})\bfv-\bfR\bfv}{\delta\bth} \\
\ccancel
&= \lim_{\delta\bth\to0}\frac{\bfR\hatx{\delta\bth}\bfv}{\delta\bth} \\
\ccross
&= \lim_{\delta\bth\to0}\frac{-\bfR\hatx{\bfv}\delta\bth}{\delta\bth} \\
&= -\bfR\hatx{\bfv} 
\end{align*}
%
The second Jacobian is defined by \eqRef{equ:derivative_vector} and trivially develops as,
%
\begin{align*}
\dpar{\bfR\bfv}{\bfv} 
&\te \lim_{\partial\bfv\to0}\frac{\bfR\tdot(\bfv+\partial\bfv)-\bfR\bfv}{\partial\bfv} \\
&= \bfR
\end{align*}

\subsubsection{Example 3: $SO(3)\times\bbR^3\to SO(3)$} 

The function $f(\bfR,\bw) = \bfR\Exp(\bw\dt)\in SO(3)$ produces elements of $SO(3)$ from elements in $SO(3)$ and vectors $\bw$ in $\bbR^3$. Its Jacobians are 
%
\begin{align*}
\dpar{\bfR\Exp(\bw\dt)}{\bth} 
&= \lim_{\delta\bth\to0}\frac{(\bfR\oplus\delta\bth)\Exp(\bw\dt)\ominus(\bfR\Exp(\bw\dt))}{\delta\bth} \\
\com{$\oplus,\ominus$}
&= \lim_{\delta\bth\to0}\frac{\Log\big((\bfR\Exp(\bw\dt))\inv \bfR\Exp(\delta\bth)\Exp(\bw\dt)\big)}{\delta\bth} \\
&= \lim_{\delta\bth\to0}\frac{\Log\big(\Exp(\bw\dt)\tr\bfR\tr \bfR\Exp(\delta\bth)\Exp(\bw\dt)\big)}{\delta\bth} \\
\ccancel
&= \lim_{\delta\bth\to0}\frac{\Log\big(\Exp(\bw\dt)\tr\Exp(\delta\bth)\Exp(\bw\dt)\big)}{\delta\bth} \\
\cswap
&= \lim_{\delta\bth\to0}\frac{\Log\big(\Exp(\Exp(\bw\dt)\tr\delta\bth)\big)}{\delta\bth} \\
\ccancel
&= \lim_{\delta\bth\to0}\frac{\Exp(\bw\dt)\tr\delta\bth}{\delta\bth} \\
&= \Exp(-\bw\dt) 
\end{align*}
%
and
%
\begin{align*}
\dpar{\bfR\Exp(\bw\dt)}{\bw} 
&= \lim_{\delta\bw\to0}\frac{\bfR\Exp((\bw+\delta\bw)\dt) \ominus (\bfR\Exp(\bw\dt)) }{\delta\bw} \\
\com{$\ominus$}
&= \lim_{\delta\bw\to0}\frac{\Log\big((\bfR\Exp(\bw\dt))\inv \, \bfR\Exp(\bw\dt+\delta\bw\dt)\big)}{\delta\bw} \\
\cJr
&= \lim_{\delta\bw\to0}\frac{\Log\big((\bfR\Exp(\bw\dt))\inv \bfR\Exp(\bw\dt)\Exp(\bfJ_r(\bw\dt)\delta\bw\dt)\big)}{\delta\bw} \\
\ccancel
&= \lim_{\delta\bw\to0}\frac{\Log\big(\Exp(\bfJ_r(\bw\dt)\delta\bw\dt)\big)}{\delta\bw} \\
\com{cancel}
&= \bfJ_r(\bw\dt)\dt
\end{align*}
%
%This can be seen in a easier way using the chain rule on $\bw\dt$,
%%
%\begin{align*}
%\dpar{\bfR\Exp(\bw\dt)}{\bw} 
%&= \dpar{\bfR\Exp(\bw\dt)}{\bw\dt}\dpar{\bf\dt}{\bw} \\
%&= \dpar{\bfR\Exp(\bw\dt)}{\bw\dt}\dt \\
%\cJr
%&= \bfJ_r(\bw\dt)\dt
%\end{align*}
%
Refer to the text for other developments, \eg~\secRef{sec:jac_first_delta}.



\subsubsection{Example 4: $SO(3)\times SO(3)\to SO(3)$}

The function $f(\bfR,\bfS) = \bfR\{\bftheta\}\,\bfS\{\bfphi\} \in SO(3)$ produces the concatenation of rotations, or rotation composition. Its Jacobians are
%
\begin{align*}
\dpar{\bfR\{\bftheta\}\,\bfS\{\bfphi\}}{\bftheta} 
&= \lim_{\delta\bftheta\to0}\frac{\Log\big((\bfR\bfS)\inv((\bfR\oplus\delta\bftheta)\bfS)\big)}{\delta\bftheta} \\
&= \lim_{\delta\bftheta\to0}\frac{\Log\big((\bfR\bfS)\tr(\bfR\Exp(\delta\bftheta)\bfS)\big)}{\delta\bftheta} \\
&= \lim_{\delta\bftheta\to0}\frac{\Log\big(\bfS\tr\bfR\tr\bfR\Exp(\delta\bftheta)\bfS\big)}{\delta\bftheta} \\
&= \lim_{\delta\bftheta\to0}\frac{\Log\big(\bfS\tr\Exp(\delta\bftheta)\bfS\big)}{\delta\bftheta} \\
\cswap
&= \lim_{\delta\bftheta\to0}\frac{\Log\big(\Exp(\bfS\tr\delta\bftheta)\big)}{\delta\bftheta} \\
&= \lim_{\delta\bftheta\to0}\frac{\bfS\tr\delta\bftheta}{\delta\bftheta} \\
&= \bfS\tr
\end{align*}
%
and
%
\begin{align*}
\dpar{\bfR\{\bftheta\}\,\bfS\{\bfphi\}}{\bfphi} 
&= \lim_{\delta\bfphi\to0}\frac{\Log\big((\bfR\bfS)\tr(\bfR(\bfS\oplus\delta\bfphi))\big)}{\delta\bfphi} \\
&= \lim_{\delta\bfphi\to0}\frac{\Log\big((\bfR\bfS)\tr(\bfR\bfS\Exp(\delta\bfphi))\big)}{\delta\bfphi} \\
&= \lim_{\delta\bfphi\to0}\frac{\Log\big(\Exp(\delta\bfphi)\big)}{\delta\bfphi} \\
&= \lim_{\delta\bfphi\to0}\frac{\delta\bfphi}{\delta\bfphi} \\
&= \bfI
\end{align*}





\section{Uncertainties in $SO(3)$}

\subsection{Description of uncertainty}
\subsubsection{Vector spaces}
\begin{align*}
\widetilde\bfx&=\bfx+\delta\bfx
\end{align*}
\subsubsection{$SO(3)$}
\begin{align*}
\widetilde\bfR&=\bfR\oplus\dth\te\bfR\Exp(\delta\bth) \\
\widetilde\bfq&=\bfq\oplus\dth\te\bfq\ot\Exp(\delta\bth)
\end{align*}

\subsection{Uncertainty propagation}

%
The uncertainty of the composition of two uncertain elements of $SO(3)$ can be derived as follows (we use the matrix form for convenience),
%
\begin{align*}
\widetilde\bfR = \bfR\Exp(\dth) 
&= \widetilde{\bfR_1\bfR_2} \\
&= \widetilde\bfR_1\widetilde\bfR_2 \\
\cexpand
&= \bfR_1\Exp(\dth_1)\bfR_2\Exp(\dth_2) \\
\cswap
&= \bfR_1\bfR_2\Exp(\bfR_2\tr\dth_1)\Exp(\dth_2) \\
\cJr
&\approx \bfR_1\bfR_2\Exp(\bfR_2\tr\dth_1+\bfJ_r\inv(\bfR_2\tr\dth_1)\dth_2) \\
&= \bfR\Exp(\bfR_2\tr\dth_1+\bfJ_r\inv(\bfR_2\tr\dth_1)\dth_2) 
\end{align*}
%
and therefore,
%
\begin{align}
\dth = \bfR_2\tr\dth_1+\bfJ_r\inv(\bfR_2\tr\dth_1)\dth_2
\end{align}
%
We can derive equivalent Jacobian matrices for the propagation. Since each partial derivative assumes null perturbations in  other variables, we have,
%
\begin{align}
\DTH_{\dth_1} \te \dpar{\bth}{\bth_1} &= \frac{\dth(\dth_2=0)}{\dth_1} = \bfR_2\tr \\
\DTH_{\dth_2} \te \dpar{\bth}{\bth_2} &= \frac{\dth(\dth_1=0)}{\dth_2} = \bfI
\end{align}
%
yielding
%
\begin{align}
\dth \approx \bfR_2\tr\dth_1+\dth_2
\end{align}
%
which constitutes a regular frame transformation operation. The covariances are propagated from $\bfR_1$ and $\bfR_2$ to $\bfR$ as 
%
\begin{align*}
\Sigma = \bfR_2\tr\,\Sigma_1\,\bfR_2 + \Sigma_2
\end{align*}

